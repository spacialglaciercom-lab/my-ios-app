
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RouteMaster">
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>RouteMaster PRO | Developer Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        #map { height: 600px; width: 100%; border-radius: 1.5rem; z-index: 1; }
        #dropZone.dragover { border-color: #2563eb; background-color: #eff6ff; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }

        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            border-radius: 1rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            max-height: 400px;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-x-hidden">

<nav class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-[1000]">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-200">
                <span class="material-symbols-outlined leading-none">terminal</span>
            </div>
            <div>
                <h1 class="font-black text-xl tracking-tight text-slate-800">RouteMaster <span class="text-blue-600">Dev</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">OSM-to-GPX Pipeline</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <label class="bg-slate-900 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-800 transition flex items-center gap-2 cursor-pointer shadow-xl shadow-slate-200" for="osm-upload">
                <span class="material-symbols-outlined text-lg">upload_file</span>
                Load OSM
                <input accept=".osm,.xml" class="hidden" id="osm-upload" onchange="handleFileUpload(event)" type="file">
            </label>
        </div>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-6 py-10 space-y-12">
    <section class="grid lg:grid-cols-12 gap-8">
        <div class="lg:col-span-8 space-y-6">
            <h2 class="text-5xl font-black text-slate-900 tracking-tight leading-tight">
                Smart Collection. <br>
                <span class="text-blue-600 underline decoration-blue-100 underline-offset-8">Zero Driveways.</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Coverage</p>
                    <p class="text-2xl font-black text-slate-800" id="stat-ways">0 Ways</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Track Distance</p>
                    <p class="text-2xl font-black text-slate-800" id="stat-dist">0.00 km</p>
                </div>
            </div>
        </div>
    </section>

    <section class="relative bg-white rounded-[2.5rem] border-8 border-white shadow-2xl shadow-slate-200 overflow-hidden" id="dropZone">
        <div id="map"></div>

        <div class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-slate-50/95 backdrop-blur-sm" id="overlay-initial">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-6">
                <span class="material-symbols-outlined text-4xl">map_search</span>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">Awaiting OSM Topology</h3>
            <button class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-blue-700 transition shadow-xl shadow-blue-200" onclick="document.getElementById('osm-upload').click()">Browse Local Files</button>
        </div>

        <div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-30 flex gap-4 hidden" id="floating-actions">
            <button class="bg-blue-600 text-white px-8 py-5 rounded-2xl font-black text-lg hover:bg-blue-700 shadow-2xl flex items-center gap-3 transition-transform active:scale-95" onclick="downloadGPX()">
                <span class="material-symbols-outlined text-2xl">download</span>
                Download GPX
            </button>
            <button class="bg-white text-slate-500 border border-slate-200 px-6 py-5 rounded-2xl font-bold hover:bg-slate-50 shadow-xl flex items-center gap-3 transition-transform active:scale-95" onclick="resetApp()">
                <span class="material-symbols-outlined">restart_alt</span>
                Reset
            </button>
        </div>
    </section>
</main>

<script>
    let map;
    let routeLayer;
    let nodeMap = new Map();
    let adj = new Map();
    let generatedRoute = [];

    function initMap() {
        map = L.map('map', {
            center: [40.7128, -74.0060],
            zoom: 12,
            zoomControl: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        setupDragAndDrop();
    }

    function setupDragAndDrop() {
        const dz = document.getElementById('dropZone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', () => { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', (e) => {
            e.preventDefault();
            dz.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) processFile(file);
    }

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => parseOSMData(e.target.result);
        reader.readAsText(file);
    }

    function parseOSMData(xmlString) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");

        nodeMap.clear();
        const nodes = xmlDoc.getElementsByTagName("node");
        for (let n of nodes) {
            nodeMap.set(n.getAttribute("id"), [
                parseFloat(n.getAttribute("lat")),
                parseFloat(n.getAttribute("lon"))
            ]);
        }

        adj.clear();
        const ways = xmlDoc.getElementsByTagName("way");
        let count = 0;
        for (let w of ways) {
            const nds = w.getElementsByTagName("nd");
            for (let i = 0; i < nds.length - 1; i++) {
                const u = nds[i].getAttribute("ref");
                const v = nds[i+1].getAttribute("ref");
                if (!adj.has(u)) adj.set(u, []);
                if (!adj.has(v)) adj.set(v, []);
                adj.get(u).push(v);
                adj.get(v).push(u);
            }
            count++;
        }

        document.getElementById('stat-ways').innerText = `${count} Ways`;
        computeEulerCircuit();
    }

    function computeEulerCircuit() {
        let localAdj = new Map();
        for (let [node, neighbors] of adj) {
            localAdj.set(node, [...neighbors]);
        }

        const startNode = [...adj.keys()][0];
        let stack = [startNode];
        let circuit = [];

        while (stack.length > 0) {
            let u = stack[stack.length - 1];
            if (localAdj.has(u) && localAdj.get(u).length > 0) {
                let v = localAdj.get(u).pop();
                stack.push(v);
            } else {
                circuit.push(stack.pop());
            }
        }

        generatedRoute = circuit.map(id => nodeMap.get(id)).filter(p => !!p);
        renderRoute();
    }

    function renderRoute() {
        if (routeLayer) map.removeLayer(routeLayer);

        routeLayer = L.polyline(generatedRoute, {
            color: '#2563eb',
            weight: 6,
            opacity: 0.9
        }).addTo(map);

        map.fitBounds(routeLayer.getBounds());

        document.getElementById('overlay-initial').classList.add('hidden');
        document.getElementById('floating-actions').classList.remove('hidden');
    }

    function resetApp() {
        if (routeLayer) map.removeLayer(routeLayer);
        document.getElementById('overlay-initial').classList.remove('hidden');
        document.getElementById('floating-actions').classList.add('hidden');
    }

    window.onload = initMap;
</script>
</body>
</html>
